# This compose file is meant to spin up a copy of supported database vendors,
# Redis, S3 (Minio) and a fake SMTP server (MailDev).
#
# ONLY FOR DEBUGGING. THIS IS NOT INTENDED FOR PRODUCTION USE.
#
# For production use see the docker compose file example in the docs:
#     https://docs.directus.io/self-hosted/docker-guide.html#example-docker-compose
#
# For receiving emails via MailDev, you'll need to add the following to your env:
#   EMAIL_FROM=directus@directus.io
#   EMAIL_TRANSPORT=smtp
#   EMAIL_SMTP_HOST=0.0.0.0
#   EMAIL_SMTP_PORT=1025
#
# Ports:
#   Maildev SMTP:    1025
#   Maildev Web-UI:  1080
#   Postgres:        5100
#   MySQL (8):       5101
#   MariaDB:         5102
#   MS SQL:          5103
#   Oracle:          5104
#   Redis:           5105
#   Minio (S3):      5106
#   Azure            5107
#   MySQL (5.7):     5108
#   Keycloak:        5110
#   Postgres (10):   5111
#   Minio Admin:     5112
#   CockroachDB:     5113
#
# Credentials:
#   Postgres:
#     User:          postgres
#     Password:      secret
#
#   MySQL:
#     User:          root
#     Password:      secret
#
#   MariaDB:
#     User:          root
#     Password:      secret
#
#   MS SQL:
#     User:          sa
#     Password:      Test@123
#
#   Oracle DB:
#     User:          secretsysuser
#     Password:      secretpassword
#     Role:          SYSDEFAULT
#     SID:           XE
#
#   Redis:
#     n/a
#
#   Minio:
#     Key:           minioadmin
#     Secret:        minioadmin
#     (Make sure to set S3_FORCE_PATH_STYLE to true)
#
#   Azure Blob Storage
#     Name:          devstoreaccount1
#     Key:           Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==
#     Container:     devstoreaccount1
#
#   Keycloak
#     User:          admin
#     Password:      secret
#
#   CockroachDB
#     User:          admin
#     Password:      --

version: '3.8'

services:
  postgres:
    image: postgis/postgis:13-3.4-alpine
    environment:
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: directus
    ports:
      - ${POSTGRES_PORT:-5100}:5432

  postgres10:
    image: postgis/postgis:10-3.2-alpine
    environment:
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: directus
    ports:
      - ${POSTGRES10_PORT:-5111}:5432

  mysql:
    image: mysql:8
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    environment:
      MYSQL_ROOT_PASSWORD: secret
      MYSQL_DATABASE: directus
    ports:
      - ${MYSQL_PORT:-5101}:3306

  mysql5:
    image: mysql:5
    environment:
      MYSQL_ROOT_PASSWORD: secret
      MYSQL_DATABASE: directus
    ports:
      - ${MYSQL5_PORT:-5108}:3306

  maria:
    image: mariadb:11.4
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    environment:
      MYSQL_ROOT_PASSWORD: secret
      MYSQL_DATABASE: directus
    ports:
      - ${MARIA_PORT:-5102}:3306

  mssql:
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=Test@123
    ports:
      - ${MSSQL_PORT:-5103}:1433

  oracle:
    image: quillbuilduser/oracle-18-xe-micro-sq
    ports:
      - ${ORACLE_PORT:-5104}:1521
    environment:
      - OPATCH_JRE_MEMORY_OPTIONS=-Xms128m -Xmx256m -XX:PermSize=16m -XX:MaxPermSize=32m -Xss1m
      - ORACLE_ALLOW_REMOTE=true
    shm_size: '1gb' # more like smh-size amirite ü•Å

  cockroachdb:
    image: cockroachdb/cockroach:latest-v23.2
    command: start-single-node --cluster-name=example-single-node --insecure
    ports:
      - ${COCKROACHDB_PORT:-5113}:26257

  redis:
    image: redis:6-alpine
    ports:
      - ${REDIS_PORT:-5105}:6379

  minio:
    image: minio/minio
    command: server /data/minio/ --console-address :9001
    ports:
      - ${MINIO_PORT:-5106}:9000
      - ${MINIO_ADMIN_PORT:-5112}:9001

  azure:
    image: mcr.microsoft.com/azure-storage/azurite
    ports:
      - ${AZURE_PORT:-5107}:10000

  keycloak:
    image: quay.io/keycloak/keycloak
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: secret
    ports:
      - ${KEYCLOAK_PORT:-5110}:8080
    command:
      - start-dev

  maildev:
    image: maildev/maildev
    ports:
      - ${MAILDEV_SMTP_PORT:-1025}:1025
      - ${MAILDEV_WEB_PORT:-1080}:1080

  # ========== OpenTelemetry Observability Stack ==========

  # OpenTelemetry Collector - receives traces, logs, and metrics
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    command: ["--config=/etc/otel-collector-config.yaml"]
    env_file:
      - observability/configs/.env.observability
    volumes:
      - ${OTEL_COLLECTOR_CONFIG_FILE:-./observability/configs/otel-collector-config.development.yaml}:/etc/otel-collector-config.yaml:ro
    ports:
      - ${OTEL_GRPC_PORT:-4317}:4317   # OTLP gRPC
      - ${OTEL_HTTP_PORT:-4318}:4318   # OTLP HTTP
      - ${OTEL_METRICS_PORT:-8888}:8888   # Prometheus metrics exposed by the collector
    depends_on:
      - tempo
      - loki
      - prometheus

  # Tempo - distributed tracing backend
  tempo:
    image: grafana/tempo:latest
    command: ["-config.file=/etc/tempo.yaml"]
    user: "0:0"
    volumes:
      - ./observability/configs/tempo.yaml:/etc/tempo.yaml:ro
      - tempo-data:/tmp/tempo
    ports:
      - ${TEMPO_PORT:-3200}:3200   # Tempo API

  # Loki - log aggregation
  loki:
    image: grafana/loki:latest
    command: ["-config.file=/etc/loki/local-config.yaml"]
    user: "0:0"
    volumes:
      - ./observability/configs/loki.yaml:/etc/loki/local-config.yaml:ro
      - loki-data:/tmp/loki
    ports:
      - ${LOKI_PORT:-3100}:3100   # Loki API

  # Prometheus - metrics
  prometheus:
    image: prom/prometheus:latest
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-remote-write-receiver'
    volumes:
      - ./observability/configs/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    ports:
      - ${PROMETHEUS_PORT:-9090}:9090   # Prometheus UI

  # Grafana - unified visualization
  grafana:
    image: grafana/grafana:latest
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    volumes:
      - ./observability/configs/grafana-datasources.yaml:/etc/grafana/provisioning/datasources/datasources.yaml:ro
      - grafana-data:/var/lib/grafana
    ports:
      - ${GRAFANA_PORT:-3000}:3000   # Grafana UI
    depends_on:
      - prometheus
      - tempo
      - loki

volumes:
  tempo-data:
  loki-data:
  prometheus-data:
  grafana-data:

