# This composer file is meant to spin up a copy of all supported database vendors and services used in tests.
#
# ONLY FOR TESTING. THIS IS NOT INTENDED FOR PRODUCTION USE.
#
# Credentials:
#   Postgres:
#     User:          postgres
#     Password:      secret
#
#   MySQL:
#     User:          root
#     Password:      secret
#
#   MariaDB:
#     User:          root
#     Password:      secret
#
#   MS SQL:
#     User:          sa
#     Password:      Test@123
#
#   Oracle DB:
#     User:          secretsysuser
#     Password:      secretpassword
#     Role:          SYSDEFAULT
#     SID:           XE
#
#   CockroachDB:
#     User:          root

version: '3.8'

services:
  postgres:
    image: postgis/postgis:17-3.5-alpine
    environment:
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: directus
    ports:
      - 6100:5432

  postgres-lts-16:
    image: postgis/postgis:16-3.5-alpine
    environment:
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: directus
    ports:
      - 6101:5432

  postgres-lts-15:
    image: postgis/postgis:15-3.5-alpine
    environment:
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: directus
    ports:
      - 6102:5432

  postgres-lts-14:
    image: postgis/postgis:14-3.5-alpine
    environment:
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: directus
    ports:
      - 6103:5432

  postgres-lts-13:
    image: postgis/postgis:13-3.5-alpine
    environment:
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: directus
    ports:
      - 6104:5432

  mysql:
    image: mysql:8.4
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    environment:
      MYSQL_ROOT_PASSWORD: secret
      MYSQL_DATABASE: directus
    ports:
      - 6105:3306

  mysql-lts-8:
    image: mysql:8.0
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    environment:
      MYSQL_ROOT_PASSWORD: secret
      MYSQL_DATABASE: directus
    ports:
      - 6106:3306

  maria:
    image: mariadb:11.4
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    environment:
      MYSQL_ROOT_PASSWORD: secret
      MYSQL_DATABASE: directus
    ports:
      - 6107:3306

  maria-lts-10_11:
    image: mariadb:10.11
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    environment:
      MYSQL_ROOT_PASSWORD: secret
      MYSQL_DATABASE: directus
    ports:
      - 6108:3306

  maria-lts-10_6:
    image: mariadb:10.6
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    environment:
      MYSQL_ROOT_PASSWORD: secret
      MYSQL_DATABASE: directus
    ports:
      - 6109:3306

  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=Test@123
      - MSSQL_PID=Express
    ports:
      - 6110:1433

  mssql-lts-2019:
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=Test@123
      - MSSQL_PID=Express
    ports:
      - 6111:1433

  oracle:
    image: container-registry.oracle.com/database/free:latest-lite
    environment:
      - OPATCH_JRE_MEMORY_OPTIONS=-Xms128m -Xmx256m -XX:PermSize=16m -XX:MaxPermSize=32m -Xss1m
      - ORACLE_ALLOW_REMOTE=true
    shm_size: '1gb' # more like smh-size ammirite 🥁
    ports:
      - 6112:1521

  cockroachdb:
    # change in the YY.R component denotes a major release
    image: cockroachdb/cockroach:latest-v24.3
    command: start-single-node --cluster-name=example-single-node --insecure
    ports:
      - 6113:26257

  cockroachdb-lts-24_1:
    image: cockroachdb/cockroach:latest-v24.1
    command: start-single-node --cluster-name=example-single-node --insecure
    ports:
      - 6114:26257

  cockroachdb-lts-23_2:
    image: cockroachdb/cockroach:latest-v23.2
    command: start-single-node --cluster-name=example-single-node --insecure
    ports:
      - 6115:26257

  cockroachdb-lts-23_1:
    image: cockroachdb/cockroach:latest-v23.1
    command: start-single-node --cluster-name=example-single-node --insecure
    ports:
      - 6116:26257

  redis:
    image: redis:6-alpine
    ports:
      - 7000:6379

  minio:
    # should stay compatible via S3 driver
    image: minio/minio
    command: server /data/minio/ --console-address :9001
    ports:
      - 8881:9000
      - 8882:9001
    environment:
      MINIO_ROOT_USER: directus
      MINIO_ROOT_PASSWORD: miniosecret

  minio-mc:
    image: minio/mc
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c " until (/usr/bin/mc alias set directusminio http://minio:9000 directus miniosecret &&
             /usr/bin/mc admin info directusminio > /dev/null 2>&1); do
          echo 'Waiting for MinIO to be ready...';
          sleep 1;
      done; /usr/bin/mc mb directusminio/directus-blackbox-test; while true; do
          sleep 3600;
      done;"

  auth-saml:
    image: kristophjunge/test-saml-idp
    ports:
      - 8880:8080
    environment:
      - SIMPLESAMLPHP_SP_ENTITY_ID=saml-test
      - SIMPLESAMLPHP_SP_ASSERTION_CONSUMER_SERVICE=http://127.0.0.1:8080/auth/login/saml/acs
    extra_hosts:
      - 'host.docker.internal:host-gateway'
